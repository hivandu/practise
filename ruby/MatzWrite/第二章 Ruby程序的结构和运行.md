本章解释了Ruby程序的结构. 首先讲解词法结构,涵盖标记(token)及组成它们的字符,接下来,讲解Ruby程序的句法结构,阐明一串标记是如何构成表达式,控制结构,类及方法之类的结构的;最后,本章描述Ruby的代码文件,解释Ruby程序是如何再多个代码文件之间进行分布的,以及Ruby解释其是如何执行一个Ruby代码文件的.

### 2.1 词法结构
Ruby解释器会把一个程序解析为一个标记序列,标记包括注释,字面量,标点符号,标识符及关键字.本节介绍标记,以及组成这些标记的字符和分割这些标记的空白符.

#### 注释
以`#`开头
##### 嵌入式文档
`=begin`开头, `=end`结尾
##### 文档化的注释
`=begin rdoc`

#### 字面量
直接出现再Ruby源代码里的值.包括数字,文本字符串以及正则表达式.

    1
    1.0
    'one'
    'two'
    /three/

#### 标点符号

#### 标识符
一个标识符就是一个名字.由数字,字母和下划线字符组成.但是不能以数字开头.
A到Z开头的标识符是常量.类和模块名必须以大写字母开头.

    i
    x2
    old_value
    _internal
    PI

惯例: 非常量的多字节标识符以下划线分割多个字节,比如`like_this`; 多字节常量则以`LikeThis`或者`LIKE_THIS`的形式表示.

##### 大小写敏感
##### 标识符中的Unicode字符
##### 标识符里的标点符号

  $ 沿袭Perl的做法,Ruby也定义了一些包含其他标点符号的全局变量,比如$_and $K.
  @ 实例变量以一个@开头,而类变量是两个@符号开头.
  ? 一个有用的惯例,返回布尔值的方法通常都有一个以问号结尾的名字.
  ! 感叹号结尾,使用时要小心.
  = 等号结尾,那么再调用此方法时可以省略此等号.这种方法通常被至于复制操作符的左侧.

#### 关键字

    _LINE_      case        ensure  note    then
    _ENCODING_  class       false   or      true
    _FILE_      def         for     redo    undef
    BEGIN       defined?    if      rescue  unless
    END         do          in      retry   until
    alias       else        module  return  when
    and         elsif       next    self    while
    begin       end         nil     super   yield
    break

除了上述关键字,还有`=begin`,`=end`,`_END_`

Ruby语言的许多重要特性实际上是用Kernel,Module,Class及Object这几个类的方法来实现的.

#### 空白符
有时候插入或删除空白符将导致程序的语义发生变化.

##### 作为语句终结符的换行符

        total = x+
        y   #这段是将x和y的和赋给total

        total = x
        +y  #这段是将x赋值给total,然后对y求值

Ruby 1.9 中,如果一行代码的第一个非空白的字符是一个句点,那么这一行将被当成是上一行的延续.

        animals = Array.new
            .push("dog")
            .push("cow")
            .push("cat")
            .sort

##### 空格符与方法调用
空白符依赖性,比如`f(3+2)+1`和`f (3+2)+1`是不同的.对于这种空白符依赖性问题的解决办法很直接:

* 永远不要再方法名和其后的左圆括号之间之间留白
* 如果一个方法的第一个参数以圆括号开头,那么再此方法的调用中,请一直使用圆括号,比如`f((3+2)+1)`;
* 请一直使用Ruby解释器的`-w`选项,这样它就会在你忘记了上述规则时发出警告.

### 2.2 句法结构
Ruby中最基本的句法单元是表达式.最简单的表达式就是初级表达式(primary expressions). 他们直接代表值,数字和字符串字面量就是初级表达式,其他的初级表达式包括特定的关键字,比如true,false,nil及self.对变量的引用也是初级表达式,对它们求值的结果就是其指向的变量的值.

符合表达式代表更复杂的值
`[1, 2, 3]`
通过操作符来组合更简单的子表达式构成符合表达式
`x = x + 1`
表达式可以和Ruby关键字联合起来构成语句.
        
        if x < 10 then
            x = x + 1
        end

        while x < 10 do
            print x
            x = x + 1
        end

区分影响程序控制流的表达式和不影响控制流的表达式之间做出区分还是有用的.

为了将表达式和语句能被重复执行而且能够操作不同的输入,将其组织称参数化的单元.被称为函数,过程或子例程.Ruby中称为`方法`

#### Ruby当中的块结构
大多数Ruby语句都包含由嵌套代码所构成的块.
Ruby程序包含两种块结构,其中之一被正式称为"块(block").这种块就是一段与迭代器(iterator)方法相关联的代码,也可以将其看成是传递给迭代器方法的代码块.

        3.times {print "ruby!"}

为了避免混淆,我们称传递给迭代器的方法为体(body).

体和块可以相互嵌套,而且典型的Ruby程序都包含几层嵌套代码,它们之间通过相对缩进来保持可读性.如 `source/2.2.1.rb`

### 2.3 文件结构
为数不多的几条规则,而且是和Ruby程序的部署有关

* 如果一个Ruby程序包含又"shebang"注释,那么该注释必须是第一行.这种注释是为了指示(Unix类)操作系统如何执行该文件.
* 如果一个Ruby程序包含一个"coding"注释,而且不包含"shebang"注释,那么该"coding"注释就该出现在第一行.
* 如果一个文件包含一行代码,该行代码仅包含一个`_END_`标记,而且前后无空白符,那么Ruby解释其将在此停止对该文件的处理.

        #!/usr/bin/ruby -w
        # -*- coding:utf-8 -*-
        require 'socket'
        ...
        _END_
        ...

### 程序的编码
默认情况下,Ruby解释器假定Ruby源代码是采用ASCII进行编码的.并不是必须,也可以处理其他编码方式,但是要它们能够代表完整的ASCII字符集即可.解释器必须要知道源文件所采用的编码方式.既可以再Ruby源文件里标示编码方式,也可以再调用Ruby解释器的时候指定编码方式.

直接采用底层字节的方式是不值得推荐的;Ruby字符串字面量支持转义序列,因此任意的字符都可以用其对应的数字编码来替代.

#### 指定程序所使用的编码
在Ruby1.8里,可以使用-K命令行选项来指定一个不同的编码. -Ku调用,运行一个UTF-8编码的包含了Unicode字符的Ruby程序.-Ke和-Ks运行采用EUC-JP或SJIS编码的包含了日本字符的程序.

Ruby 1.9 同样支持-K选项,但不再是指定程序文件编码方式的优先选择.在文件开头放入特殊的"编码注释(coding comment)"来指定编码:
`# coding: utf-8`

字符串coding可以包含任意的前缀,比如encoding.整个注释,包含coding字符串和编码名称,都不区分大小写.

特例，如果一个文件的头三个字节是OxEF OxBB OxBf，那么该文件的编码方式就是UTF-8。这三个字节被成为BOM（Byte Order Mark的缩写）。

Ruby1.9中，关键字`_ENCODING_`(在开头和结尾各有两个下划线)含有当前正在执行的代码的源代码。其结果值是一个Encoding对象。

#### 2.4.2 源编码和默认外部编码
通常采用编码注释来设定一个文件的源编码。源编码会告诉Ruby解释其如何解读一个脚本中的字符。一个Ruby程序可以包含多个文件，不同的文件可以采用不同的源编码。一个文件的源编码会影响到该文件中的字符串字面量的编码方式。

默认外部编码是不同的：他是当Ruby从文件或流中读取内容时采用的默认编码。默认外部编码对于Ruby进程来说是全局性的，而且不会随着文件的不同而改变。默认外部编码不改变字符串字面量的编码方式，但是对于I/O来讲是非常重要的。

`-K`解释器选项之前被描述成一种设定源编码的方式，事实上，这个选项真正做的事情是设置进程的默认外部编码，然后用这个编码作为默认的源编码。

`-K`是为了与1.8兼容，但并不是首选的设置默认外部编码的方式。两个新选项， -E和-encoding,允许通过其全名而不是单字符缩写的方式和来制定编码。

        Ex: ruby -E utf-8           #Encoding name follows -E
            ruby -Eutf-8            #The Space is optional
            ruby --encoding utf-8   #Encoding following --encoding with a space
            ruby --encoding=utf-8   #Or use an equals sign with --encoding

可以使用`Encoding.default_external`查询默认外部编码，它返回一个Encoding对象。也可以使用`Encoding.locale_charmap`获得从区域设置得到的字符编码的名称（作为字符串）。这个方法是基于区域设置的，并且会忽略那些用于覆盖默认外部编码的命令行选项。

### 2.5 Ruby程序的运行

Ruby的控制结构可以更改默认的执行顺序，比如按条件执行或重复执行。Ruby解释器先扫描BEGIN语句，然后执行该语句包含的代码。之后回到第一行顺序执行。

Ruby和编译型语言之间的另一个差异与模块，类和方法定义有关。编译型语言里，上述语法结构是由编译器进行处理的,在Ruby中，它们也是语句。

通常，Ruby解释器在退出之前会执行任何END语句。









